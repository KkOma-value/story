# 账号密码登录系统 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 改造小说推荐系统前端，从邮箱登录改为支持账号名或邮箱的账号密码登录系统，包含邮箱验证码注册和密码重置功能

**Architecture:** 保持User模型不变（邮件唯一标识），改造登录API支持账号名或邮箱登录，新增密码重置API，更新前端页面和API客户端

**Tech Stack:** React + TypeScript + Ant Design + Vite，Django + Django REST Framework + JWT

---

## 项目状态

**已完成：**
- ✅ 后端登录API修改：支持账号名或邮箱登录
- ✅ 后端新增密码重置API：发送重置邮件、验证验证码、重置密码

**待完成：**
- 前端登录页面改造：支持账号名/邮箱输入
- 前端注册页面优化：优化用户体验
- 新增密码重置页面
- 更新API客户端和类型定义
- 更新前端路由
- 更新mock API数据

---

### Task 1: 更新类型定义

**Files:**
- Modify: `frontend/src/types/index.ts`

**变更：** 更新LoginRequest支持credential字段

```typescript
export interface LoginRequest {
  credential: string;  // 邮箱或账号名
  password: string;
}
```

**实现步骤：**

1. 打开文件并定位到LoginRequest接口（第54-57行）
2. 修改字段（从前端配合后端）：email → credential

---

### Task 2: 更新API接口定义

**Files:**
- Modify: `frontend/src/api/interface.ts`

**变更：**

1. login方法改用credential字段
2. 新增密码重置相关接口

**实现步骤：**

1. 在interface中添加两个新方法：

```typescript
sendResetEmailCode(email: string): Promise<void>;
resetPassword(data: { email: string; code: string; password: string; confirmPassword: string }): Promise<void>;
```

---

### Task 3: 更新真实的API实现

**Files:**
- Modify: `frontend/src/api/real.ts`

**实现步骤：**

1. 更新login方法使用credential字段：

```typescript
async login(req: LoginRequest): Promise<LoginResponse> {
  const res = await http.post<ApiResponse<LoginResponse>>('/api/auth/login', req);
  return unwrap(res.data);
}
```

2. 添加密码重置相关实现：

```typescript
async sendResetEmailCode(email: string): Promise<void> {
  const res = await http.post<ApiResponse<{ sent: boolean }>>('/api/auth/reset-code', { email });
  return unwrap(res.data);
}

async resetPassword(data: { email: string; code: string; password: string; confirmPassword: string }): Promise<void> {
  const res = await http.post<ApiResponse<{ success: boolean }>>('/api/auth/reset-password', data);
  return unwrap(res.data);
}
```

---

### Task 4: 更新mock API实现

**Files:**
- Modify: `frontend/src/api/mock.ts`

**实现步骤：**

1. 更新login方法：

```typescript
async login(req: LoginRequest): Promise<LoginResponse> {
  await delay();

  // 支持模拟账号名和邮箱登录
  let user: any = null;

  // 检查是否为管理员账号
  if (req.credential === 'admin' || req.credential === 'admin@test.com') {
    if (req.password === 'admin123') {
      user = {
        id: 'admin-uuid',
        username: '管理员',
        displayName: '系统管理员',
        email: 'admin@test.com',
        role: 'admin',
        avatarUrl: null,
        bio: null,
        status: 'active'
      };
    }
  } else if (req.password === '123456' || req.password === 'test') {
    user = {
      id: 'user-uuid',
      username: '测试用户',
      displayName: '普通用户',
      email: 'user@test.com',
      role: 'user',
      avatarUrl: null,
      bio: null,
      status: 'active'
    };
  }

  if (!user) {
    throw new Error('账号或密码错误');
  }

  const token = 'mock-token-' + Date.now();

  return {
    token,
    user: {
      id: user.id,
      username: user.username,
      role: user.role as 'user' | 'admin',
    }
  };
}
```

2. 添加密码重置相关mock方法：

```typescript
async sendResetEmailCode(email: string): Promise<void> {
  await delay();

  if (!email.includes('@')) {
    throw new Error('邮箱格式不正确');
  }

  // 模拟发送成功
  console.log(`[Mock] 重置密码验证码已发送到: ${email}`);
}

async resetPassword(data: { email: string; code: string; password: string; confirmPassword: string }): Promise<void> {
  await delay();

  if (data.password !== data.confirmPassword) {
    throw new Error('两次密码不一致');
  }

  if (data.code !== '123456') {
    throw new Error('验证码错误');
  }

  // 模拟重置成功
  console.log(`[Mock] 密码重置成功 for: ${data.email}`);
}
```

---

### Task 5: 更新登录页面

**Files:**
- Modify: `frontend/src/pages/LoginPage.tsx`

**实现步骤：**

1. 更新界面标题和描述：
   - 将输入框标签改为"账号/邮箱"
   - 标签更新为"邮箱或账号名"
   - 删除邮箱格式验证

2. 更新表单验证：

```typescript
// 移除邮箱验证规则
rules={[
  { required: true, message: '请输入账号/邮箱' },
]}
```

3. 添加忘记密码链接：

```typescript
<div className="text-center text-text-muted">
  <Link to="/forgot-password" className="text-primary hover:text-primary-400 ml-1 transition-colors">
    忘记密码？
  </Link>
</div>
```

---

### Task 6: 优化注册页面

**Files：**
- Optimize: `frontend/src/pages/RegisterPage.tsx`

**实现步骤：**

1. 账号名输入框下方添加：

```typescript
<div className="text-xs text-text-muted mt-1">
  账号名可以重复，用于登录和显示
</div>
```

2. 邮箱输入框下方添加说明：

```typescript
<div className="text-xs text-text-muted mt-1">
  邮箱用于接收验证码和找回密码，请确保正确
</div>
```

---

### Task 7: 新增密码重置页面

**Files：**
- Create: `frontend/src/pages/ResetPasswordPage.tsx`

**实现步骤：**

多步骤表单流程：
1. 输入邮箱发送验证码
2. 输入验证码和新密码
3. 重置成功返回登录

---

### Task 8: 更新路由配置

**Files：**
- Update: `frontend/src/router.tsx`

**实现步骤：**

1. 将密码重置路径添加到路由：

```typescript
{ path: '/forgot-password', element: <ResetPasswordPage /> },
```

---

### Task 9: 测试完整流程

**测试：**

1. 注册：账号名 + 邮箱验证
2. 登录：账号名登录、邮箱登录
3. 密码重置：邮箱验证 + 重置
4. 错误处理验证

---

**Plan complete and saved to docs/plans/2026-01-18-账号密码登录系统.md.**

**Two execution options:**

1. **Subagent-Driven (this session)** - I dispatch fresh subagent per task, review between tasks, fast iteration

2. **Parallel Session (separate)** - Open new session with executing-plans, batch execution with checkpoints

**Which approach?**
